"use strict";angular.module("kvvApp",[]).run(["SVGRepository","Line",function(a,b){return a.load("images/all.svg"),b.init()}]),angular.module("kvvApp").directive("map",["SVGRepository","TrainPainter","LinePainter","Line","LocationPainter","StopPainter",function(a,b,c,d,e,f){return{template:"<canvas resize></canvas>",restrict:"E",link:function(a,g){var h;return h=g.find("canvas"),paper.setup(h[0]),paper.scale=10,e.create(new paper.Point({x:490,y:530})),d.fetchData().then(function(){var a,e,g,h,i;return g=d.getLines(),e=new paper.Group,h=new paper.Group,g.forEach(function(a){return c.create(a.path,a),e.addChild(a.item),a.stops.forEach(function(b){return f.create(b,a),h.addChild(b.item)}),a.trains.forEach(function(c){return b.create(c,a),h.addChild(c.item)})}),e.addChild(h),e.scale(paper.scale),i=new paper.Tool,i.onMouseDrag=function(a){var b;return b=paper.project.activeLayer.position.add(a.delta),b.y-e.bounds.height/2>0?b.y=e.bounds.height/2:b.y+e.bounds.height/2<paper.view.size.height&&(b.y=paper.view.size.height-e.bounds.height/2),b.x-e.bounds.width/2>0?b.x=e.bounds.width/2:b.x+e.bounds.width/2<paper.view.size.width&&(b.x=paper.view.size.width-e.bounds.width/2),paper.project.activeLayer.setPosition(b)},a=1e-4,paper.view.onFrame=function(){var b,c,d,e,f,h,i,j,k,l;for(e=0,l=[];e<g.length;){for(d=g[e++],k=0;k<d.trains.length;){if(j=d.trains[k++],j.stopCounter>0)j.stopCounter<50?j.stopCounter++:j.stopCounter=0;else{for(b=!1,i=0;i<d.stops.length;)Math.abs(d.stops[i++].position-j.position)<a&&(b=!0);b&&j.stopCounter++}0===j.stopCounter&&(j.position+=j.direction*a,(j.position>=1||j.position<=0)&&(j.direction*=-1),f=j.line.item.firstChild.getPointAt(j.line.item.firstChild.length*j.position),j.item.position=f)}i=0,l.push(function(){var a;for(a=[];i<d.stops.length;)if(h=d.stops[i++],0===h.priority){for(c=!1,k=0;k<d.trains.length;)Math.abs(d.trains[k++].position-h.position)<.007&&(c=!0);c?h.size<20?(h.item.firstChild.scale(1.005),a.push(h.size++)):a.push(void 0):h.size>0?(h.item.firstChild.scale(1/1.005),a.push(h.size--)):a.push(void 0)}else a.push(void 0);return a}())}return l}})}}}]),angular.module("kvvApp").service("SVGRepository",function(){return{pathElements:[],load:function(a){var b=this;return $.ajax({url:a,async:!1,dataType:"text",success:function(a){return b.pathElements=$(a).find("path")}})},getPathElements:function(){return this.pathElements}}}),angular.module("kvvApp").service("Line",["SVGRepository","$http","$q",function(a,b,c){var d,e;return this.lines=[],e=[],this.init=function(){var b;return b=a.getPathElements(),b.each(function(a,b){return e.push(b)})},this.getLines=function(){return this.lines},this.getApiLink=function(a){return"http://www.kvv.de/tunnelEfaDirect.php?action=XML_GEOOBJECT_REQUEST&itdLPxx_line="+a+"&mergeDir=1&mergeProj=1&hideBannerInfo=1&filterEpsilon=5.0&returnSinglePath=1&outputFormat=JSON&command=bothdirections&line="+a+"&language=d"},this.getPathForName=function(a){var b,c;return c=/_(.*)/i,b=e.filter(function(b){return c.exec(b.id)[1]===a}),b[0]},this.fetchData=function(){var a,e,f;return f=this,e=function(a,b){return Math.floor(Math.random()*(b-a+1))+a},a=function(a){var b,c,d,e,f,g;for(a=a.map(function(a){return a.split(",")}),g=0,f=[a[0]],b=1,c=a.length;c>b;)d=a[b-1],e=a[b],g+=Math.pow(d[0]-e[0],2)+Math.pow(d[1]-e[1],2),a[b].push(g),b++;return a.map(function(a){return a.push(a[2]/g||0),a})},b.get("api/lines.json").then(function(g){var h,i;return h=g.data,i=[],h.forEach(function(c){var g;return g=b.get("api/kvv/"+c.name+".json").then(function(b){var g,h,i,j,k,l,m,n;for(i=b.data.geoObjects.items[0].item.points.map(function(a){return a.ref.coords}),l=b.data.geoObjects.items[0].item.points,g=a(i),h=0,n=[];h<i.length;)k=l.filter(function(a){return a.ref.coords===i[h]})[0],m=g[h][3],k&&n.push({id:h,name:k.name,position:m||0,priority:e(0,2),line:f}),h++;return j=f.getPathForName(c.name),c=new d(j,n,c.name),f.lines.push(c)},function(){}),i.push(g)}),c.all(i)})},d=function(){function a(a,b,c){this.path=a,this.name=c,this.stops=b,this.trains=[{position:.1,stopCounter:0,line:this,direction:-1},{position:.2,stopCounter:0,line:this,direction:1},{position:.3,stopCounter:0,line:this,direction:-1},{position:.4,stopCounter:0,line:this,direction:1},{position:.5,stopCounter:0,line:this,direction:-1},{position:.6,stopCounter:0,line:this,direction:1},{position:.7,stopCounter:0,line:this,direction:-1},{position:.8,stopCounter:0,line:this,direction:1},{position:.9,stopCounter:0,line:this,direction:-1},{position:1,stopCounter:0,line:this,direction:1}]}return a}(),this}]),angular.module("kvvApp").service("TrainPainter",function(){return{create:function(a){var b,c,d,e,f,g,h;return d=a.line.item.firstChild.length,f=a.line.item.firstChild.getPointAt(d*a.position),e=new paper.Path.Circle(f,21),e.fillColor="#fff",c=new paper.Path.Circle(f,19),c.fillColor=a.line.item.firstChild.strokeColor,h=f.add(new paper.Point({x:0,y:7})),g=new paper.PointText(h),g.justification="center",g.fillColor="#fff",g.content=a.line.name,g.font="Nevis",g.fontSize=21,b=new paper.Group([e,c,g]),b.scale(1/paper.scale),a.item=b}}}),angular.module("kvvApp").service("LinePainter",function(){return{create:function(a,b){var c;return c=paper.project.importSVG(a),c.strokeWidth=4,b.item=new paper.Group(c)}}}),angular.module("kvvApp").service("LocationPainter",function(){return{create:function(a){var b,c,d,e,f;return c=new paper.Path.Circle(a,60),c.fillColor="#fcdecf",e=new paper.Path.Circle(a,39),e.fillColor="#f8b595",f=new paper.Path.Circle(a,30),f.fillColor="#fac3aa",d=new paper.Path.Circle(a,22),d.fillColor="#f37840",b=new paper.Path.Circle(a,13),b.fillColor="#f15610"}}}),angular.module("kvvApp").service("StopPainter",function(){return{create:function(a,b){var c,d,e,f;return e=b.item.firstChild.length,f=b.item.firstChild.getPointAt(e*a.position),d=new paper.Group,0===a.priority?(c=new paper.Path.Circle(f,21),c.strokeWidth=4,c.strokeColor=b.item.firstChild.strokeColor,c.fillColor="#fff",a.size=0,d.addChild(c),c.onClick=function(a){var b;return b=new paper.Raster("images/popup.png"),b.position=a.point.add(new paper.Point({x:30,y:-100})),b.onClick=function(){return b.remove()}}):(c=new paper.Path.Circle(f,7),c.fillColor=b.item.firstChild.strokeColor,d.addChild(c)),d.scale(1/paper.scale,f),a.item=d}}}),angular.module("kvvApp").service("MapPainter",function(){}),angular.module("kvvApp").service("Adjustpainter",function(){});