"use strict";angular.module("kvvApp",[]).run(["SVGRepository","Line",function(a,b){return a.load("images/all.svg"),b.init()}]),angular.module("kvvApp").directive("map",["SVGRepository","TrainPainter","LinePainter","Line","LocationPainter","StopPainter",function(a,b,c,d,e,f){return{template:"<canvas resize></canvas>",restrict:"E",link:function(g,h){var i,j,k,l,m;return i=h.find("canvas"),paper.setup(i[0]),paper.view.zoom=2,e.create(new paper.Point({x:400,y:320})),l=a.getPathElements(),l.each(function(){return c.create(this)}),k=d.getLines(),k.forEach(function(a){return a.item=c.create(a.item),a.trains.forEach(function(c){return c.item=b.create(c,a)}),a.stops.forEach(function(b){return f.create(b,a)})}),f.create({position:.4,line:{color:"#FECB0D",item:paper.project.layers[0].children[5]}}),m=new paper.Tool,j=.001,paper.view.onFrame=function(){return k.forEach(function(a){return a.trains.forEach(function(a){return!a.direction&&a.position>=0?a.position-=j:a.position<=0?a.direction=!0:a.position>=1&&a.direction?a.direction=!1:a.position<=1&&a.direction&&(a.position+=j),a.item.position=a.line.item.getPointAt(a.line.item.length*a.position)})})},m.onMouseDrag=function(a){return paper.project.activeLayer.setPosition(paper.project.activeLayer.position.add(a.delta))}}}}]),angular.module("kvvApp").service("SVGRepository",function(){return{pathElements:[],load:function(a){var b=this;return $.ajax(a,{url:"http://localhost:8080/base/app/images/all.svg",async:!1,dataType:"text",success:function(a){return b.pathElements=$(a).find("path")}})},getPathElements:function(){return this.pathElements}}}),angular.module("kvvApp").service("Line",["SVGRepository","$http",function(a,b){var c,d;return this.lines=[],this.init=function(){return this.createLines(a.getPathElements()),this.fetchData()},this.createLines=function(a){var b=this;return a.each&&a.each(function(a,d){return b.lines.push(new c(d))})},this.getLines=function(){return this.lines},this.getApiLink=function(a){return"http://www.kvv.de/tunnelEfaDirect.php?action=XML_GEOOBJECT_REQUEST&itdLPxx_line="+a+"&mergeDir=1&mergeProj=1&hideBannerInfo=1&filterEpsilon=5.0&returnSinglePath=1&outputFormat=JSON&command=bothdirections&line="+a+"&language=d"},this.fetchData=function(){var a;return a=this,b.get("/api/lines.json").then(function(c){var d;return d=c.data,d.forEach(function(c){return b.get(a.getApiLink(c.apiKey)).then(function(){})})})},d=/L_(.*)/i,c=function(){function a(a){var b;this.item=a,this.name=d.exec(a.id)[1],this.stops=[{id:1,name:"Waldstadt Europäische Schule",position:0,line:this},{id:2,name:"Waldstadt Osteroder Straße",position:.05,line:this},{id:3,name:"Waldstadt Elbinger Str. (Ost)",position:.15,line:this},{id:4,name:"Waldstadt Jägerhaus",position:.2,line:this},{id:5,name:"Waldstadt Zentrum",position:.25,line:this},{id:6,name:"Waldstadt Glogauer Straße",position:.3,line:this},{id:7,name:"Waldstadt Im Eichbäumle",position:.33,line:this},{id:8,name:"Hagsfeld Fächerbad",position:.36,line:this},{id:9,name:"Rintheim Sinsheimer Straße",position:.4,line:this},{id:10,name:"Karlsruhe Hirtenweg/Techn.park",position:.45,line:this},{id:11,name:"Karlsruhe Hauptfriedhof",position:.5,line:this},{id:12,name:"Karlsruhe Karl-Wilhelm-Platz",position:.54,line:this},{id:13,name:"Karlsruhe Durlacher Tor / KIT",position:.58,line:this},{id:14,name:"Karlsruhe Kolpingplatz",position:.62,line:this},{id:15,name:"Karlsruhe Ebertstraße",position:.65,line:this},{id:16,name:"Karlsruhe,Hbf Vorplatz",position:.69,line:this},{id:17,name:"Karlsruhe Poststraße",position:.73,line:this},{id:18,name:"Karlsruhe Tivoli",position:.75,line:this},{id:19,name:"Karlsruhe Kronenpl.(Kaiserstr)",position:.77,line:this},{id:20,name:"Karlsruhe Marktpl.(Kaiserstr)",position:.8,line:this},{id:21,name:"Karlsruhe Herrenstraße",position:.81,line:this},{id:22,name:"Karlsruhe Europaplatz (Kaiser)",position:.83,line:this},{id:23,name:"Karlsruhe Europaplatz (Karl)",position:.87,line:this},{id:24,name:"Karlsruhe Karlstor",position:.9,line:this},{id:25,name:"Karlsruhe Mathystraße",position:1,line:this}],b=new Date,this.trains=[{position:.1,line:this,direction:!0,nextStops:[{id:1,name:"Waldstadt Europäische Schule","in":new Date(b.getTime()+1e3)},{id:2,name:"Waldstadt Osteroder Straße","in":new Date(b.getTime()+2e3)},{id:3,name:"Waldstadt Elbinger Str. (Ost)","in":new Date(b.getTime()+3e3)},{id:4,name:"Waldstadt Jägerhaus","in":new Date(b.getTime()+4e3)},{id:5,name:"Waldstadt Zentrum","in":new Date(b.getTime()+5e3)},{id:6,name:"Waldstadt Glogauer Straße","in":new Date(b.getTime()+6e3)},{id:7,name:"Waldstadt Im Eichbäumle","in":new Date(b.getTime()+7e3)},{id:8,name:"Hagsfeld Fächerbad","in":new Date(b.getTime()+8e3)},{id:9,name:"Rintheim Sinsheimer Straße","in":new Date(b.getTime()+9e3)},{id:10,name:"Karlsruhe Hirtenweg/Techn.park","in":new Date(b.getTime()+1e4)},{id:11,name:"Karlsruhe Hauptfriedhof","in":new Date(b.getTime()+11e3)},{id:12,name:"Karlsruhe Karl-Wilhelm-Platz","in":new Date(b.getTime()+12e3)},{id:13,name:"Karlsruhe Durlacher Tor / KIT","in":new Date(b.getTime()+13e3)},{id:14,name:"Karlsruhe Kolpingplatz","in":new Date(b.getTime()+14e3)},{id:15,name:"Karlsruhe Ebertstraße","in":new Date(b.getTime()+15e3)},{id:16,name:"Karlsruhe,Hbf Vorplatz","in":new Date(b.getTime()+16e3)}]}]}return a}(),this}]),angular.module("kvvApp").service("TrainPainter",function(){return{create:function(a){var b,c,d,e,f,g;return c=a.line.item.length,e=a.line.item.getPointAt(c*a.position),d=new paper.Path.Circle(e,6),d.fillColor="#fff",b=new paper.Path.Circle(e,5),b.fillColor=a.line.item.strokeColor,g=e.add(new paper.Point({x:0,y:1.5})),f=new paper.PointText(g),f.justification="center",f.fillColor="#fff",f.content=a.line.name,f.font="Montserrat",f.fontSize=4,a.item=new paper.Group([d,b,f])}}}),angular.module("kvvApp").service("LinePainter",function(){return{create:function(a,b){return b={},b.item=paper.project.importSVG(a)}}}),angular.module("kvvApp").service("LocationPainter",function(){return{create:function(a){var b,c,d,e;return b=new paper.Path.Circle(a,27),b.fillColor="#fde2d5",d=new paper.Path.Circle(a,18),d.fillColor="#fabfa1",e=new paper.Path.Circle(a,9),e.fillColor="#f58b54",c=new paper.Path.Circle(a,4),c.fillColor="#f36f2b"}}}),angular.module("kvvApp").service("StopPainter",function(){return{create:function(a){var b,c,d;return c=a.line.item.length,d=a.line.item.getPointAt(c*a.position),b=new paper.Path.Circle(d,3),b.fillColor=a.line.item.strokeColor,a.item=b}}});